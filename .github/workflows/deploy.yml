name: üöÄ TONIX CHAIN Auto Deploy + Release + Telegram Notify

on:
  push:
    branches: [ "main" ]

jobs:
  build-and-release:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 18

      - name: Install dependencies
        run: npm install --legacy-peer-deps

      - name: Build TONIX CHAIN
        run: npm run build

      - name: Deploy to Vercel
        id: vercel_deploy
        env:
          VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
          VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
          VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}
        run: |
          npx vercel --prod --force --confirm --yes
          echo "DEPLOY_URL=https://tonix-chain.vercel.app" >> $GITHUB_ENV

      - name: Fetch TON contract balance
        id: ton_balance
        run: |
          sudo apt-get update && sudo apt-get install -y jq
          CONTRACT="EQBtB8vIHgdO49Ih02Yt9kD5tDKxOTrFgZHkRkAjFTrvJziT"
          RESPONSE=$(curl -s "https://toncenter.com/api/v2/getAddressBalance?address=$CONTRACT")
          BALANCE=$(echo $RESPONSE | jq -r '.result' | awk '{printf "%.3f", $1/1000000000}')
          echo "BALANCE=${BALANCE}" >> $GITHUB_ENV

      - name: Fetch last on-chain event
        id: ton_event
        run: |
          CONTRACT="EQBtB8vIHgdO49Ih02Yt9kD5tDKxOTrFgZHkRkAjFTrvJziT"
          RESPONSE=$(curl -s "https://toncenter.com/api/v2/getTransactions?address=$CONTRACT&limit=1")
          EVENT=$(echo $RESPONSE | jq -r '.result[0].in_msg.source // empty' | head -c 20)
          if [ -z "$EVENT" ]; then EVENT="‚Äî"; fi
          echo "EVENT=${EVENT}" >> $GITHUB_ENV

      - name: Get commit info and changelog
        id: commit_info
        run: |
          AUTHOR=$(git log -1 --pretty=format:'%an')
          MESSAGE=$(git log -1 --pretty=format:'%s')
          LAST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "v0.0.0")
          NEW_TAG=$(echo $LAST_TAG | awk -F. -v OFS=. '{$NF+=1;print}')
          echo "AUTHOR=${AUTHOR}" >> $GITHUB_ENV
          echo "MESSAGE=${MESSAGE}" >> $GITHUB_ENV
          echo "NEW_TAG=${NEW_TAG}" >> $GITHUB_ENV
          echo "üì¶ New tag: ${NEW_TAG}"
          CHANGELOG=$(git log ${LAST_TAG}..HEAD --pretty=format:'- %s (%an)' --no-merges || echo "- Initial release")
          echo "CHANGELOG<<EOF" >> $GITHUB_ENV
          echo "${CHANGELOG}" >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV

      - name: Create new tag and push
        env:
          NEW_TAG: ${{ env.NEW_TAG }}
        run: |
          git config user.name "tonix-bot"
          git config user.email "bot@tonixchain.io"
          git tag -a ${NEW_TAG} -m "Release ${NEW_TAG}"
          git push origin ${NEW_TAG}

      - name: Notify Telegram
        if: always()
        env:
          DEPLOY_URL: https://tonix-chain.vercel.app
          BALANCE: ${{ env.BALANCE }}
          EVENT: ${{ env.EVENT }}
          AUTHOR: ${{ env.AUTHOR }}
          MESSAGE: ${{ env.MESSAGE }}
          NEW_TAG: ${{ env.NEW_TAG }}
          CHANGELOG: ${{ env.CHANGELOG }}
        run: |
          STATUS=${{ job.status }}
          VERSION=${NEW_TAG}
          MESSAGE_TEXT="üöÄ *TONIX CHAIN Release Report*\n\n*Status:* ${STATUS}\n*Version:* ${VERSION}\n*Branch:* main\n*Time:* $(date '+%H:%M:%S')\n\nüë§ *Author:* ${AUTHOR}\nüìù *Commit:* ${MESSAGE}\n\nüìú *Changelog since last release:*\n${CHANGELOG}\n\nüíé *Contract Balance:* ${BALANCE} TON\nüì° *Last Event:* ${EVENT}\n\nüåê [Open Mini App](https://t.me/tonixchain_lottery_bot/app?startapp=lottery)\nüîó [Vercel Deploy](${DEPLOY_URL})"
          curl -s -X POST https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage \
          -d chat_id=${{ secrets.TELEGRAM_CHAT_ID }} \
          -d parse_mode="Markdown" \
          -d text="$MESSAGE_TEXT"
